package com.security.auditor.repository;

import com.security.auditor.model.entity.DetectionSource;
import com.security.auditor.model.entity.RiskLevel;
import com.security.auditor.model.entity.ScanResult;
import com.security.auditor.model.entity.Vulnerability;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

/**
 * Vulnerability Repository
 * Data access layer for Vulnerability entity
 */
@Repository
public interface VulnerabilityRepository extends JpaRepository<Vulnerability, Long> {

    /**
     * Find all vulnerabilities by scan result
     */
    List<Vulnerability> findByScanResult(ScanResult scanResult);

    /**
     * Find all vulnerabilities by scan result ID
     */
    List<Vulnerability> findByScanResultId(Long scanResultId);

    /**
     * Find vulnerabilities by severity
     */
    List<Vulnerability> findBySeverity(RiskLevel severity);

    /**
     * Find vulnerabilities by scan result and severity
     */
    List<Vulnerability> findByScanResultIdAndSeverity(Long scanResultId, RiskLevel severity);

    /**
     * Find vulnerabilities by type
     */
    List<Vulnerability> findByVulnerabilityType(String vulnerabilityType);

    /**
     * Find vulnerabilities by detection source
     */
    List<Vulnerability> findByDetectionSource(DetectionSource detectionSource);

    /**
     * Find vulnerabilities by scan result and detection source
     */
    List<Vulnerability> findByScanResultIdAndDetectionSource(Long scanResultId, DetectionSource detectionSource);

    /**
     * Find vulnerabilities by SWC ID
     */
    List<Vulnerability> findBySwcId(String swcId);

    /**
     * Find vulnerabilities by CWE ID
     */
    List<Vulnerability> findByCweId(String cweId);

    /**
     * Find vulnerabilities marked as false positive
     */
    List<Vulnerability> findByFalsePositive(Boolean falsePositive);

    /**
     * Find vulnerabilities by confidence score greater than threshold
     */
    @Query("SELECT v FROM Vulnerability v WHERE v.confidenceScore > :threshold")
    List<Vulnerability> findHighConfidenceVulnerabilities(@Param("threshold") Double threshold);

    /**
     * Find vulnerabilities by line number range
     */
    @Query("SELECT v FROM Vulnerability v WHERE v.scanResult.id = :scanResultId AND v.lineNumber BETWEEN :startLine AND :endLine")
    List<Vulnerability> findByLineNumberRange(@Param("scanResultId") Long scanResultId, 
                                               @Param("startLine") Integer startLine, 
                                               @Param("endLine") Integer endLine);

    /**
     * Count vulnerabilities by scan result
     */
    long countByScanResultId(Long scanResultId);

    /**
     * Count vulnerabilities by severity
     */
    long countBySeverity(RiskLevel severity);

    /**
     * Count vulnerabilities by scan result and severity
     */
    long countByScanResultIdAndSeverity(Long scanResultId, RiskLevel severity);

    /**
     * Count vulnerabilities by type
     */
    long countByVulnerabilityType(String vulnerabilityType);

    /**
     * Count critical vulnerabilities across all scans
     */
    @Query("SELECT COUNT(v) FROM Vulnerability v WHERE v.severity = 'CRITICAL'")
    long countCriticalVulnerabilities();

    /**
     * Find most common vulnerability types
     */
    @Query("SELECT v.vulnerabilityType, COUNT(v) as count FROM Vulnerability v GROUP BY v.vulnerabilityType ORDER BY count DESC")
    List<Object[]> findMostCommonVulnerabilityTypes();

    /**
     * Find vulnerabilities by scan result ordered by severity
     */
    @Query("SELECT v FROM Vulnerability v WHERE v.scanResult.id = :scanResultId ORDER BY " +
           "CASE v.severity " +
           "WHEN 'CRITICAL' THEN 1 " +
           "WHEN 'HIGH' THEN 2 " +
           "WHEN 'MEDIUM' THEN 3 " +
           "WHEN 'LOW' THEN 4 " +
           "WHEN 'INFO' THEN 5 " +
           "END")
    List<Vulnerability> findByScanResultIdOrderBySeverity(@Param("scanResultId") Long scanResultId);

    /**
     * Find vulnerabilities with recommendations
     */
    @Query("SELECT v FROM Vulnerability v WHERE v.recommendation IS NOT NULL AND v.recommendation != ''")
    List<Vulnerability> findVulnerabilitiesWithRecommendations();

    /**
     * Delete vulnerabilities by scan result ID
     */
    void deleteByScanResultId(Long scanResultId);
}
